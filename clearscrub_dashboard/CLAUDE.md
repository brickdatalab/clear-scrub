# ClearScrub Dashboard - CLAUDE.md

This file provides guidance for development on the React dashboard frontend.

## Production-Only Workflow (VINCENT'S RULE)

**ðŸ”´ ALL dashboard work goes DIRECTLY to production. NO local testing.**

### Making Dashboard Changes

**Files Modified:** `src/` directory (pages, components, hooks, services, types, layouts)

**Change Examples:**
- Adding new page components in `src/pages/`
- Modifying existing components in `src/components/`
- Updating API calls in `src/services/api.ts`
- Changing types in `src/types/`
- Modifying hooks in `src/hooks/`

**Deployment Process:**

1. Make changes to React/TypeScript files in `src/`
2. From `clearscrub_dashboard/` directory, run: `vercel --prod`
3. Wait 1-2 minutes for Vercel to build and deploy
4. Tell Vincent to refresh browser at `https://dashboard.clearscrub.io`
5. Changes are live immediately

**NO `npm run dev` testing. NO staging environment. Changes go straight to production.**

### Verification

After deployment:
- Vincent refreshes browser at `https://dashboard.clearscrub.io`
- Changes should be visible in the dashboard (may require hard refresh with Cmd+Shift+R)
- Check browser console for any errors

### Key Files Structure

- `src/pages/` - Page components (Companies, CompanyDetail, Login, SignUp, etc.)
- `src/components/` - Reusable components (TopBar, Sidebar, BankSummarySection, etc.)
- `src/services/api.ts` - All Edge Function API calls + **PHASE 2: Complete CRUD API layer**
- `src/hooks/useAuth.tsx` - Authentication context and hooks
- `src/lib/supabaseClient.ts` - Supabase client configuration
- `src/types/` - TypeScript interfaces

### Recent Updates

**Phase 2 Complete (October 22, 2025):**
- Complete API Service Layer in `src/services/api.ts`
- 20+ CRUD functions across 4 modules:
  1. **API Keys Module:** getApiKeys, createApiKey, regenerateApiKey, revokeApiKey, deleteApiKey
  2. **Email Notifications Module:** getEmailNotifications, addEmailNotification, updateEmailNotification, removeEmailNotification, testEmailNotification
  3. **Webhooks Module:** getWebhooks, createWebhook, updateWebhook, deleteWebhook, testWebhook
  4. **Automation Triggers Module:** getTriggers, createTrigger, updateTrigger, deleteTrigger, toggleTrigger
- All mutations write to audit_log table for compliance
- All queries enforce RLS via org_id filtering
- Cryptographically secure key generation (API keys: cs_live_*, webhook secrets: whsec_*)
- Session management via waitForSession() ensures JWT authentication
- TypeScript interfaces for type safety

**Database Enhancement:**
- Updated `handle_new_user()` trigger to auto-create default API key on signup
- Format: `cs_live_{48_hex_chars}`, SHA-256 hashed, stored with is_default=true
- Migration: `20251022_update_signup_trigger_add_default_api_key.sql`

**Phase 9b Complete (October 23, 2025):**
- Performance optimization via manual vendor chunking
- 86% reduction in main bundle size (549 KB â†’ 73 KB)
- 8 vendor chunks load in parallel for better caching
- Automatic modulepreload hints generated by Vite
- Performance test scripts: `scripts/performance-test.sh`, `scripts/migrate-icons.sh`
- Comprehensive documentation:
  - `README_PERFORMANCE.md` - Quick start guide
  - `PERFORMANCE_REPORT.md` - Full technical analysis
  - `PERFORMANCE_COMPARISON.md` - Before/after comparison
  - `OPTIMIZATION_GUIDE.md` - Implementation guide
  - `PHASE_9B_SUMMARY.md` - Executive summary

**Phase 10 Complete (October 23, 2025) - FINAL MIGRATION PHASE:**
- âœ… Deleted legacy infrastructure:
  - Removed `src/config/uiVariant.ts` (feature flag system)
  - Removed `src/pages/UiSandbox.tsx` (dev route)
  - Removed `src/pages/DataTableTest.tsx` (dev route)
  - Removed `src/components/ui-compat/` (entire 18-file compatibility layer)
  - Removed `src/lib/cn.ts` (legacy utility)
  - Removed `src/lib/icons.ts` (Phase 9b optimization causing type errors)
- âœ… Updated all component imports from ui-compat to direct shadcn imports (17+ files)
- âœ… Fixed component API mismatches:
  - Card components: Updated to use CardHeader/CardContent/CardFooter child components
  - Dialog components: Updated to use DialogContent/DialogHeader/DialogTitle/DialogFooter
  - Alert components: Updated to use AlertDescription child component
  - Button variants: Changed "primary" to "default", removed "md" size
- âœ… Removed feature flag code from App.tsx (withUiVariantFromQuery)
- âœ… Removed dev routes from App.tsx (/ui-sandbox, /datatable-test)
- âœ… Build verification: 0 TypeScript errors
- âœ… Production deployment: LIVE at https://dashboard.clearscrub.io
- **MIGRATION FROZEN:** shadcn/ui migration is complete, no legacy fallback code remains

**Next Phase (Phase 3):**
- Remove ALL mock data from Settings page
- Connect Settings UI to real API endpoints
- Full production-ready Settings functionality

### Current Production URL

- **Frontend:** `https://dashboard.clearscrub.io`
- **Local:** `http://localhost:5173` (reference only, NOT used for actual testing)

### Deployment Command Reference

```bash
# Deploy to production
cd clearscrub_dashboard
vercel --prod
```

**Status:** ACTIVE - APPLY TO ALL DASHBOARD WORK
